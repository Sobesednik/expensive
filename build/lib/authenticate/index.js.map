{"version":3,"sources":["../../../src/lib/authenticate/index.js"],"names":["LOG","url","authenticate","user","password","ip","phone","chrome","port","client","res","Page","Network","DOM","Runtime","Input","requestIntercepted","interceptionId","request","blocked","continueInterceptedRequest","errorReason","undefined","enable","setRequestInterception","patterns","urlPattern","navigate","encodeURIComponent","loadEventFired","login","selectPhone","enterCode","a","addIpAddress","err","message","close","kill","console","log","fetchNewIp","name","csrf","accountPassword","ipAddress","data","j","JSON","stringify","result","exceptionDetails","evaluate","expression","awaitPromise","Error","exception","description","parse","value","__isError","__errorType","Success","Array","isArray","Errors","Message","Date","toLocaleString","replace","submitSelector","selectSelector","options","option","find","i","endsWith","map","join","v","keys","slice","length","text","mapPhoneOptions","answer","getDefault","validation","p","some","val","info","r","exec","b","code"],"mappings":"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","sourcesContent":["/* eslint-disable no-console */\nimport { debuglog } from 'util'\nimport { equal } from 'assert'\nimport CDP from 'chrome-remote-interface'\nimport Chrome from 'chrome-remote-interface/lib/chrome' // eslint-disable-line no-unused-vars\nimport { askSingle } from 'reloquent'\nimport { mapPhoneOptions, checkAuth, isBlocked, click, evaluate, getValue, setValue, checkLimit } from './lib'\nimport { writeFileSync } from 'fs'\n\nconst LOG = debuglog('expensive')\n\nconst url = 'https://ap.www.namecheap.com/settings/tools/apiaccess/whitelisted-ips'\n\nconst authenticate = async ({\n  user,\n  password,\n  ip, // ip to set\n  phone,\n  chrome,\n}) => {\n  const { port } = chrome\n  LOG('Chrome debugging port running on %s', port)\n\n  /** @type {Chrome} */\n  let client\n  let res\n  let Page\n  try {\n    client = await CDP({\n      port,\n    })\n    const { Network, DOM, Runtime, Input } = client\n    ;({ Page } = client)\n\n    Network.requestIntercepted(({ interceptionId, request }) => {\n      const blocked = isBlocked(request.url)\n      if (!blocked) {\n        LOG(request.url)\n      }\n      Network.continueInterceptedRequest({\n        interceptionId,\n        errorReason: blocked ? 'Aborted' : undefined,\n      })\n    })\n    // enable events then start!\n    await Network.enable()\n    await Page.enable()\n    await DOM.enable()\n    await Runtime.enable()\n\n    await Network.setRequestInterception({ patterns: [{ urlPattern: '*' }] })\n    // await Network.setCacheDisabled({ cacheDisabled: true })\n\n    await Page.navigate({ url: `https://www.namecheap.com/myaccount/login-signup.aspx?ReturnUrl=${encodeURIComponent(url)}` })\n    await Page.loadEventFired()\n    await login(Runtime, { user, password })\n    await Page.loadEventFired()\n\n    await checkAuth(Runtime)\n\n    await selectPhone(Runtime, phone)\n    await Page.loadEventFired()\n\n    await enterCode(Runtime)\n    await Page.loadEventFired()\n\n    const a = await evaluate(Runtime, 'location.href')\n    equal(a, url, `Unexpected url: ${a}`)\n\n    await addIpAddress(Runtime, Input, { ip, password })\n    res = true\n  } catch (err) {\n    LOG(err)\n    res = err.message\n  } finally {\n    if (client) {\n      // const { data } = await Page.captureScreenshot()\n      // writeFileSync('debug.png', Buffer.from(data, 'base64'))\n      await client.close()\n    }\n  }\n\n  await chrome.kill()\n  console.log('Chrome killed')\n  return res\n}\n\nconst fetchNewIp = async (Runtime, {\n  name,\n  csrf,\n  password: accountPassword,\n  ip: ipAddress,\n}) => {\n  const data = {\n    accountPassword,\n    name,\n    ipAddress,\n  }\n  const j = JSON.stringify(data)\n  const url = 'https://ap.www.namecheap.com/api/v1/ncpl/apiaccess/ui/AddIpAddress'\n  const { result, exceptionDetails } = await Runtime.evaluate({\n    expression: `\n      (async () => {\n        const response = await fetch('${url}', {\n          body: '${j}',\n          cache: 'no-cache',\n          credentials: 'include',\n          headers: {\n            'x-ncpl-rcsrf': '${csrf}',\n            'content-type': 'application/json',\n          },\n          method: 'POST',\n        })\n        const contentType = response.headers.get('content-type')\n        if(contentType && contentType.includes('application/json')) {\n          const j = await response.json()\n          return JSON.stringify(j)\n        }\n        throw new Error(\"haven't got a JSON\")\n      })()\n`,\n    awaitPromise: true,\n  })\n  if (exceptionDetails) {\n    throw new Error(exceptionDetails.exception.description)\n  }\n  const res = JSON.parse(result.value)\n  if (res.__isError) {\n    throw new Error(res.__errorType)\n  }\n  if (!res.Success) {\n    if (!Array.isArray(res.Errors)) {\n      throw new Error('The request was not successful')\n    }\n    const [{ Message }] = res.Errors\n    throw new Error(Message)\n  }\n}\n\nconst addIpAddress = async (Runtime, Input, { ip, password }) => {\n  const name = `expensive ${new Date().toLocaleString()}`.replace(/:/g, '-')\n  const csrf = await evaluate(Runtime, 'document.querySelector(\"#x-ncpl-csrfvalue\").value')\n  await fetchNewIp(Runtime, {\n    password,\n    name,\n    ip,\n    csrf,\n  })\n  // await new Promise(r => setTimeout(r, 1000)) // wait for\n  // await focus(Runtime, '#ip-name')\n  // for (let i = 0; i < name.length; i++) {\n  //   await Input.dispatchKeyEvent({ type: 'char', text: name[i] })\n  // }\n  // await focus(Runtime, '#ip-address')\n  // for (let i = 0; i < ip.length; i++) {\n  //   await Input.dispatchKeyEvent({ type: 'char', text: ip[i] })\n  // }\n  // await evaluate(Runtime, 'document.querySelectorAll(\\'input[type=\"password\"]\\')[1].focus()')\n  // for (let i = 0; i < password.length; i++) {\n  //   await Input.dispatchKeyEvent({ type: 'char', text: password[i] })\n  // }\n  // await evaluate(Runtime, 'document.querySelectorAll(\\'button.gb-btn--primary\\')[1].click()')\n}\n\nconst login = async (Runtime, { user, password }) => {\n  await setValue(Runtime, 'input.nc_username', user)\n  await setValue(Runtime, 'input.nc_password', password)\n  await click(Runtime, 'input.nc_login_submit')\n}\n\nconst selectPhone = async (Runtime, phone) => {\n  const submitSelector = 'input[type=\"submit\"]'\n  const selectSelector = 'select.verification-method'\n  /** @type {{v: string, i: string}[]} */\n  const options = await evaluate(Runtime, `\n  Array.from(document.querySelectorAll('${selectSelector} > option'))\n    .map(p => ({v: p.value, i: p.innerHTML }))`, true)\n\n  if (phone) {\n    const option = options.find(({ i }) => i.endsWith(phone))\n    if (!option) throw new Error(`A phone number ending with ${phone} cannot be found. Added numbers: ${options.map(({ i }) => i).join(', ')}`)\n    await evaluate(Runtime, `document.querySelector('${selectSelector}').value = \"${option.v}\"`)\n    await evaluate(Runtime, `document.querySelector('${submitSelector}').click()`)\n    return\n  }\n\n  const keys = options.map(({ i }) => i.slice(i.length - 3))\n\n  if (options.length) {\n    const text = `Which phone number to use for 2 factor auth\n${\n  options\n    .map(({ i }) => ` ${i}`)\n    .map(mapPhoneOptions)\n    .join('\\n')\n}\nenter last 3 digits`\n\n    const answer = await askSingle({\n      text,\n      async getDefault() {\n        return phone || keys[0]\n      },\n      validation(a) {\n        const p = options.some(({ i }) => i.endsWith(a))\n        if (!p) {\n          throw new Error('unknown number entered')\n        }\n      },\n    })\n\n    console.log(answer)\n    const { v } = options.find(({ i }) => i.endsWith(answer))\n    await Runtime.evaluate({\n      expression: `document.querySelector('select.verification-method').value = \"${v}\"`,\n    })\n  }\n  await Runtime.evaluate({\n    expression: `document.querySelector('input[type=\"submit\"]').click()`, // eslint-disable-line\n  })\n}\n\nconst enterCode = async (Runtime) => {\n  const val = await getValue(Runtime, 'input[type=\"submit\"]')\n  equal(val, 'Submit Security Code', 'Did not get to the page with verification of security code')\n\n  /** @type {string} */\n  const info = await Runtime.evaluate({\n    expression: `document.querySelector('.info').innerText`, // eslint-disable-line\n  })\n  const r = /Your \\d-digit code begins with (\\d)/.exec(info.result.value)\n  if (!r) {\n    await checkLimit(Runtime)\n    throw new Error('Could not enter the code') // return\n  }\n\n  const [, b] = r\n\n  const code = await askSingle({\n    text: `Security code (begins with ${b})`,\n  })\n\n  await setValue(Runtime, 'input[placeholder=\"Verification Code\"]', code)\n  await click(Runtime, 'input[type=\"submit\"]')\n}\n\nexport default authenticate\n"],"file":"index.js"}